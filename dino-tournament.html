<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dino - Tounwa</title>
  <style>
    :root{ --bg:#f7f7f7; --ground:#7a7a7a; --dino:#222 }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Arial}
    .game-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px 20px 120px 20px;box-sizing:border-box;gap:20px}
    .stage{position:relative;width:800px;max-width:95vw;height:250px;background:linear-gradient(#f7f7f7,#f1f1f1);overflow:hidden;border:1px solid #ddd;box-shadow:0 8px 30px rgba(0,0,0,0.06);border-radius:6px}
    canvas{display:block;width:100%;height:100%;}
    .ui{position:absolute;left:12px;top:12px;font-weight:700;color:#555}
    .score{position:absolute;right:12px;top:12px;font-weight:700;color:#555}
    .players-left{position:absolute;left:12px;bottom:12px;background:rgba(37,99,235,0.9);color:white;padding:8px 16px;border-radius:6px;font-weight:700;font-size:14px;}
    .controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:12px;align-items:center}
    .btn{appearance:none;border:0;background:#111;color:#fff;padding:10px 18px;border-radius:6px;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,0.15);cursor:pointer;user-select:none;touch-action:manipulation}
    #jumpBtn{padding:20px 60px;font-size:18px;font-weight:800}
    .btn:active{transform:translateY(1px)}
    .hint{color:#888;font-size:12px;text-align:center}
    @media (max-width:480px){.stage{height:200px} #jumpBtn{padding:18px 50px;font-size:16px}}
  </style>
</head>
<body>
  <div class="game-wrap">
    <div class="stage" id="stage">
      <canvas id="c" width="800" height="250"></canvas>
      <div class="ui">Tounwa Dino</div>
      <div class="score" id="score">0</div>
      <div class="players-left" id="playersLeft">ðŸ‘¥ JwÃ¨: --</div>
    </div>
    <div class="controls">
      <button id="jumpBtn" class="btn">Sauter</button>
      <div class="hint">Ã‰vite les cactus et les ptÃ©rodactyles !</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDpylenTapoLXwbMsEavlLt0po5M_bVDBo",
      authDomain: "mopyonsiteweb.firebaseapp.com",
      databaseURL: "https://mopyonsiteweb-default-rtdb.firebaseio.com/",
      projectId: "mopyonsiteweb",
      storageBucket: "mopyonsiteweb.firebasestorage.app",
      messagingSenderId: "535172052074",
      appId: "1:535172052074:web:c30cefea18ffed7a27c613"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const rtdb = firebase.database();
  </script>
  
  <script src="firebaseTournaments.js"></script>

  <script>
  (function(){
    // RÃ©cupÃ©rer les infos du tournoi
    const tournamentInfo = JSON.parse(localStorage.getItem('currentTournament') || '{}');
    if (!tournamentInfo.tournamentId) {
      alert("ErÃ¨: Pa gen enfÃ²masyon sou tounwa a!");
      window.location.href = 'tournaments-home.html';
      return;
    }

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    let W = canvas.width, H = canvas.height;

    let running = true;
    let score = 0;
    let speed = 6;
    let frame = 0;
    let nextSpeedIncrease = 300;
    let hasLost = false;

    const dino = {
      x: 50,
      y: H - 48 - 40,
      w: 44,
      h: 40,
      vy: 0,
      grounded: true,
      jumpPower: 13,
      gravity: 0.7,
    };

    const groundY = H - 48;
    let obstacles = [];
    let pterodactyls = [];
    let lastCactusFrame = 0;
    let lastPteroFrame = 0;
    let obstacleGap = 120;

    // Ã‰couter le nombre de joueurs restants
    let totalPlayers = 0;
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const { tournamentId, roomKey } = tournamentInfo;
        
        // RÃ©cupÃ©rer le nombre total de joueurs
        const playingData = await rtdb.ref(`tournaments/${roomKey}/playing/${tournamentId}/players`).once('value');
        totalPlayers = playingData.val().length;
        updatePlayersLeft(totalPlayers);

        // Ã‰couter les rÃ©sultats pour compter les joueurs restants
        const resultsRef = rtdb.ref(`tournaments/${roomKey}/playing/${tournamentId}/results`);
        resultsRef.on('value', (snapshot) => {
          const lostCount = snapshot.numChildren();
          const remaining = totalPlayers - lostCount;
          updatePlayersLeft(remaining);
        });

        // DÃ©marrer l'Ã©coute des rÃ©sultats du tournoi
        listenForTournamentEnd(tournamentId, roomKey, totalPlayers);
      }
    });

    function updatePlayersLeft(count) {
      document.getElementById('playersLeft').textContent = `ðŸ‘¥ JwÃ¨: ${count}`;
    }

    function spawnObstacle(){
      const types = [ {w:20,h:40}, {w:28,h:50}, {w:12,h:30} ];
      const t = types[Math.floor(Math.random()*types.length)];
      obstacles.push({x:W+20,w:t.w,h:t.h,y:groundY - t.h});
    }

    function spawnPterodactyl(){
      const height = groundY - 110;
      pterodactyls.push({
        x: W + 30,
        y: height,
        w: 36,
        h: 24,
        wingOffset: Math.random() * Math.PI * 2,
        speed: speed + Math.random() * 2 + 1
      });
    }

    const jumpBtn = document.getElementById('jumpBtn');

    function doJump(){
      if(!running || hasLost) return;
      if(dino.grounded){
        dino.vy = -dino.jumpPower;
        dino.grounded = false;
      }
    }

    jumpBtn.addEventListener('click', doJump);
    jumpBtn.addEventListener('touchstart', function(e){ 
      e.preventDefault(); 
      e.stopPropagation();
      doJump(); 
    }, {passive:false});
    
    jumpBtn.addEventListener('touchend', function(e){ 
      e.preventDefault(); 
      e.stopPropagation();
    }, {passive:false});
    
    document.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, {passive: false});

    document.addEventListener('touchstart', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault();
      }
    }, {passive: false});

    window.addEventListener('keydown', function(e){ 
      if(e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        doJump();
      }
    });

    function clear(){ ctx.clearRect(0,0,W,H); }

    function drawGround(){
      ctx.fillStyle = '#e9e9e9';
      ctx.fillRect(0, groundY, W, H - groundY);
      ctx.strokeStyle = '#cfcfcf';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, groundY);
      ctx.lineTo(W, groundY);
      ctx.stroke();
    }

    function drawDino(){
      ctx.fillStyle = '#111';
      ctx.fillRect(dino.x, dino.y, dino.w, dino.h);
      ctx.fillStyle = '#fff';
      ctx.fillRect(dino.x + dino.w - 12, dino.y + 10, 6, 6);
    }

    function drawObstacle(o){
      ctx.fillStyle = '#333';
      ctx.fillRect(o.x, o.y, o.w, o.h);
    }

    function drawPterodactyl(p){
      ctx.fillStyle = '#555';
      ctx.fillRect(p.x + 8, p.y + 8, p.w - 16, p.h - 16);
      
      const wingFlap = Math.sin(frame * 0.3 + p.wingOffset) * 0.5 + 0.5;
      const wingHeight = 6 + wingFlap * 4;
      
      ctx.fillStyle = '#666';
      ctx.fillRect(p.x, p.y + 6, 12, wingHeight);
      ctx.fillRect(p.x + p.w - 12, p.y + 6, 12, wingHeight);
      
      ctx.fillStyle = '#444';
      ctx.fillRect(p.x + p.w - 8, p.y + 10, 8, 4);
    }

    function checkCollision(rect1, rect2) {
      return rect1.x < rect2.x + rect2.w &&
             rect1.x + rect1.w > rect2.x &&
             rect1.y < rect2.y + rect2.h &&
             rect1.y + rect1.h > rect2.y;
    }

    async function handleGameOver() {
      if (hasLost) return;
      hasLost = true;
      running = false;

      // Enregistrer la perte dans Firebase
      const { tournamentId, roomKey } = tournamentInfo;
      await onPlayerLose(tournamentId, roomKey);
    }

    let last = performance.now();
    function loop(now){
      if(!running) return;
      const dt = (now - last) / 16.6667;
      last = now;
      frame++;

      if(!dino.grounded){
        dino.vy += dino.gravity * dt;
        dino.y += dino.vy * dt;
        if(dino.y >= groundY - dino.h){
          dino.y = groundY - dino.h;
          dino.vy = 0;
          dino.grounded = true;
        }
      }

      const obstacleFreq = Math.max(35, 80 - Math.floor(score/150));
      if(frame % obstacleFreq === 0){
        spawnObstacle();
        lastCactusFrame = frame;
      }

      if(score >= 300) {
        const pteroFreq = Math.max(120, 180 - Math.floor(score/200));
        if(frame % pteroFreq === 0 && Math.random() < 0.3 && frame - lastCactusFrame > obstacleGap){
          spawnPterodactyl();
          lastPteroFrame = frame;
        }
      }

      for(let i = obstacles.length-1; i >= 0; i--){
        const o = obstacles[i];
        o.x -= speed * dt;
        
        if(checkCollision(dino, o)){
          handleGameOver();
        }
        
        if(o.x + o.w < -50) obstacles.splice(i,1);
      }

      for(let i = pterodactyls.length-1; i >= 0; i--){
        const p = pterodactyls[i];
        p.x -= p.speed * dt;
        
        if(checkCollision(dino, p)){
          handleGameOver();
        }
        
        if(p.x + p.w < -50) pterodactyls.splice(i,1);
      }

      if(frame % 3 === 0) score += 1;
      
      if(score >= nextSpeedIncrease) {
        speed += 0.8;
        nextSpeedIncrease += 300;
      }
      
      updateScoreDisplay();

      clear();
      drawGround();
      drawDino();
      obstacles.forEach(drawObstacle);
      pterodactyls.forEach(drawPterodactyl);

      if(running) requestAnimationFrame(loop);
    }

    function updateScoreDisplay(){
      document.getElementById('score').textContent = score;
    }

    // DÃ©marrer le jeu
    loop(performance.now());
  })();
  </script>
</body>
</html>