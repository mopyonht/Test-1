<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Win-Earn Ha√Øti Wallet - EziPay</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
/* ===== STYLES ===== */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
       background: linear-gradient(135deg, blue 0%, red 95%); min-height:100vh; padding:20px; color:white; }
.container { max-width:800px; margin:0 auto; }
.header { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
         border-radius:20px; padding:30px; margin-bottom:20px;
         display:flex; justify-content:space-between; align-items:center; }
.balance-amount { font-size:36px; font-weight:bold; }
.message { padding:15px; border-radius:10px; margin-bottom:20px; display:none; }
.message.success { background: rgba(16,185,129,0.2); color:#10b981; border:1px solid rgba(16,185,129,0.3); }
.message.error { background: rgba(239,68,68,0.2); color:#ef4444; border:1px solid rgba(239,68,68,0.3); }
.card { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius:20px; overflow:hidden; }
.tabs { display:flex; border-bottom:1px solid rgba(255,255,255,0.2); }
.tab { flex:1; padding:20px; text-align:center; color: rgba(255,255,255,0.6); cursor:pointer;
       border:none; background:transparent; font-size:16px; transition:all 0.3s; }
.tab:hover { background: rgba(255,255,255,0.05); }
.tab.active { background: rgba(255,255,255,0.2); color:white; }
.tab-content { padding:30px; display:none; }
.tab-content.active { display:block; }
.form-group { margin-bottom:20px; }
label { display:block; margin-bottom:8px; font-weight:500; }
input, select { width:100%; padding:12px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.2);
                background: rgba(255,255,255,0.1); color:white; font-size:16px; outline:none; }
input::placeholder { color: rgba(255,255,255,0.5); }
.btn { width:100%; padding:15px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.3s; }
.btn-deposit { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; }
.btn-withdraw { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; }
.btn:disabled { opacity:0.5; cursor:not-allowed; }
.info-box, .fee-info { padding:12px; border-radius:8px; margin-top:15px; font-size:14px; }
.info-box { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); }
.fee-info { background: rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); color:#fbbf24; }
.transaction-item { background: rgba(255,255,255,0.05); padding:20px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1); }
.helper-text { font-size:12px; color: rgba(255,255,255,0.6); margin-top:5px; }
.divider { text-align:center; color: rgba(255,255,255,0.6); margin:15px 0; }
.loading { text-align:center; color:white; padding:40px; }
</style>
</head>
<body>
<div class="container">

    <div class="header">
        <div>
            <h1>Win-Earn Ha√Øti Wallet</h1>
            <p>Bienvenue, <span id="userName">Chargement...</span></p>
        </div>
        <div style="text-align:right;">
            <p style="opacity:0.8; font-size:14px;">Solde disponible</p>
            <p class="balance-amount">$<span id="balance">0.00</span></p>
        </div>
    </div>
    
       <!-- üîΩ Ton image ajout√©e ici -->
    <img src="paiement.jpg" alt="Paiement illustration" style="width:100%; border-radius:10px; margin-bottom:15px;">
    <!-- üîº Tu peux la d√©placer o√π tu veux -->

    <div id="message" class="message"></div>

           <div style="max-width:400px; margin:20px auto; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15); background-color:#fff; text-align:center; font-family:Arial, sans-serif;">
    <h2 style="color: red; margin-bottom:10px;">Siw bezwen √®d pou depo ak retr√® ekri nou whatsapp : 509 34125103</h2>
           </div>
      

    <div class="card">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('deposit')">üí∞ D√©p√¥t</button>
            <button class="tab" onclick="switchTab('withdraw')">üí∏ Retrait</button>
            <button class="tab" onclick="switchTab('history')">üìú Historique</button>
        </div>

        <!-- D√âP√îT -->
        <div id="deposit-tab" class="tab-content active">
            <div class="form-group">
                <label>Montant</label>
                <input type="number" id="deposit-amount" placeholder="0.00" step="0.01" min="0.01">
            </div>
            <div class="form-group">
                <label>Devise</label>
                <select id="deposit-currency">
                    <option value="USD">USD - Dollar am√©ricain</option>
                    <option value="HTG">HTG - Gourde ha√Øtienne</option>
                </select>
            </div>
            <button class="btn btn-deposit" onclick="handleDeposit()">D√©poser</button>
            <div class="fee-info">‚ú® Depo a ka pran tan pou li monte sou kont ou. Bay ajan nou yo yon ti tan silvoupl√®. K√®k segond a k√®k minit s√®lman.</div>
            <div class="info-box">üí≥ Paiement s√©curis√© via EziPay Wallet<br>‚úì M√©thodes: EziPay, MonCash</div>
        </div>

        <!-- RETRAIT -->
        <div id="withdraw-tab" class="tab-content">
            <div class="form-group">
                <label>Montant √† retirer</label>
                <input type="number" id="withdraw-amount" placeholder="0.00" step="0.01" min="0.01">
                <p class="helper-text">Solde: $<span id="balance-helper">0.00</span></p>
            </div>
            <div class="form-group">
                <label>Devise</label>
                <select id="withdraw-currency">
                    <option value="USD">USD</option>
                    <option value="HTG">HTG</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="withdraw-email" placeholder="exemple@email.com">
            </div>
            <div class="divider">OU</div>
            <div class="form-group">
                <label>T√©l√©phone</label>
                <input type="tel" id="withdraw-phone" placeholder="+1234567890">
            </div>
            <div class="form-group">
                <label>M√©thode</label>
                <select id="withdraw-method">
                    <option value="">S√©lectionner...</option>
                    <option value="1">EziPay</option>
                    <option value="16">MonCash</option>
                </select>
            </div>
            <button class="btn btn-withdraw" onclick="handleWithdraw()">Retirer</button>
            <div class="fee-info">‚ÑπÔ∏è Frais de transaction: 6% (d√©duits de votre solde)</div>
        </div>

        <!-- HISTORIQUE -->
        <div id="history-tab" class="tab-content">
            <div id="transaction-list" class="loading">Chargement...</div>
        </div>
    </div>
</div>

<script>
const RAILWAY_URL = 'https://ezipay-backend-production.up.railway.app';

// ===== Firebase config =====
const firebaseConfig = {
    apiKey: "AIzaSyDpylenTapoLXwbMsEavlLt0po5M_bVDBo",
    authDomain: "mopyonsiteweb.firebaseapp.com",
    databaseURL: "https://mopyonsiteweb-default-rtdb.firebaseio.com/",
    projectId: "mopyonsiteweb",
    storageBucket: "mopyonsiteweb.firebasestorage.app",
    messagingSenderId: "535172052074",
    appId: "1:535172052074:web:c30cefea18ffed7a27c613",
    measurementId: "G-CLYT5CXJ79"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let balance = 0;

// ===== Auth =====
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        document.getElementById('userName').textContent = user.email;
        await loadUserBalance();
        await loadTransactionHistory();
        checkForPendingTransaction();
    } else {
        window.location.href = 'login.html';
    }
});

// ===== Balance =====
async function loadUserBalance() {
    const doc = await db.collection('users').doc(currentUser.uid).get();
    balance = doc.exists ? (doc.data().balance || 0) : 0;
    updateBalanceUI();
}
function updateBalanceUI() {
    document.getElementById('balance').textContent = balance.toFixed(2);
    document.getElementById('balance-helper').textContent = balance.toFixed(2);
}

// ===== Messages =====
function showMessage(text,type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
    msg.style.display = 'block';
    setTimeout(()=> msg.style.display='none',5000);
}

// ===== Tabs =====
function switchTab(tab,event) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    if(event) event.target.classList.add('active');
    document.getElementById(tab+'-tab').classList.add('active');
}

// ===== Deposit =====
async function handleDeposit() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    const currency = document.getElementById('deposit-currency').value;
    if(!amount || amount<=0){ showMessage('Montant invalide','error'); return; }

    try{
        const res = await fetch(`${RAILWAY_URL}/api/create-deposit`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({userId:currentUser.uid, amount, currency})
        });
        const data = await res.json();
        if(data.success){
            localStorage.setItem('pending_deposit', JSON.stringify({amount, timestamp:Date.now()}));
            window.location.href = data.payment_url;
        } else showMessage('‚ùå '+data.error,'error');
    } catch(e){ showMessage('‚ùå Erreur connexion','error'); }
}

// ===== Verify deposit after redirect =====
function checkForPendingTransaction() {
    const urlParams = new URLSearchParams(window.location.search);
    const deposit = urlParams.get('deposit');
    
    if (deposit === 'success') {
        showMessage('‚úÖ Paiement envoy√©! Votre solde sera cr√©dit√© sous peu par un admin.', 'success');
        localStorage.removeItem('pending_deposit');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// ===== Withdraw =====
async function handleWithdraw(){
    const amount=parseFloat(document.getElementById('withdraw-amount').value);
    const currency=document.getElementById('withdraw-currency').value;
    const email=document.getElementById('withdraw-email').value;
    const phone=document.getElementById('withdraw-phone').value;
    const method=document.getElementById('withdraw-method').value;
    const totalDebit = amount*1.06;

    if(!amount || amount<=0){ showMessage('Montant invalide','error'); return; }
    if(totalDebit>balance){ showMessage('Solde insuffisant','error'); return; }
    if(!email && !phone){ showMessage('Email ou t√©l√©phone requis','error'); return; }
    if(!method){ showMessage('M√©thode requise','error'); return; }

    if(!confirm(`Retrait: $${amount}\nFrais: $${(totalDebit-amount).toFixed(2)}\nTotal d√©bit√©: $${totalDebit}\nContinuer?`)) return;

    const btn=document.querySelector('.btn-withdraw'); btn.disabled=true; btn.textContent='Traitement...';

    try{
        const res = await fetch(`${RAILWAY_URL}/api/create-withdrawal`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({userId:currentUser.uid, amount, currency, emailOrPhone:email||phone, paymentMethodId:method})
        });
        const data = await res.json();
        if(data.success){
            balance = data.newBalance;
            updateBalanceUI();
            await loadTransactionHistory();
            showMessage(`‚úÖ Retrait effectu√©! -$${data.totalDebit.toFixed(2)}`,'success');
            document.getElementById('withdraw-amount').value='';
            document.getElementById('withdraw-email').value='';
            document.getElementById('withdraw-phone').value='';
            document.getElementById('withdraw-method').value='';
        } else showMessage('‚ùå '+data.error,'error');
    }catch(e){ showMessage('‚ùå Erreur connexion','error'); }
    finally{ btn.disabled=false; btn.textContent='Retirer'; }
}

// ===== Transactions =====
async function loadTransactionHistory(){
    const list=document.getElementById('transaction-list');
    try{
        const snapshot=await db.collection('users').doc(currentUser.uid)
            .collection('transactions')
            .orderBy('date','desc')
            .limit(50)
            .get();
        if(snapshot.empty){ list.innerHTML='<p style="text-align:center;color:white;padding:40px;">Aucune transaction</p>'; return; }
        list.innerHTML=snapshot.docs.map(doc=>{
            const t=doc.data();
            const isDeposit=t.type==='deposit';
            return `
                <div class="transaction-item">
                    <div style="display:flex;justify-content:space-between;">
                        <div>
                            <strong>${isDeposit?'‚¨áÔ∏è D√©p√¥t':'‚¨ÜÔ∏è Retrait'}</strong>
                            <div style="font-size:12px;opacity:0.7;">${t.date ? new Date(t.date.toDate()).toLocaleString():'Date inconnue'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:18px;font-weight:bold;color:${isDeposit?'#10b981':'#3b82f6'}">
                                ${isDeposit?'+':'-'}$${(isDeposit?t.creditAmount:t.totalDebit).toFixed(2)}
                            </div>
                            <div style="font-size:12px;opacity:0.7;">${t.status}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }catch(e){ list.innerHTML='<p style="color:#ef4444;">Erreur chargement</p>'; }
}
</script>
</body>
</html>
